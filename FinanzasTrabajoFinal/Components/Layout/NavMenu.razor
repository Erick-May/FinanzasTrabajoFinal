@* --- ¡QUITA EL @rendermode DE AQUÍ! --- *@

@implements IDisposable
@using FinanzasTrabajoFinal.Service
@inject UserStateService UserStateService
@inject NavigationManager NavigationManager

<nav class="navbar navbar-expand-lg fb-navbar container-fluid">

    <a class="navbar-brand d-flex align-items-center gap-2" href="/">
        <span class="brand-logo">F</span>
        <span class="brand-text">FinanzasApp</span>
    </a>

    <div class="collapse navbar-collapse" id="topNavbar">
        <ul class="navbar-nav ms-auto align-items-lg-center">
            <li class="nav-item d-flex align-items-center me-2">
                <a class="nav-link nav-icon" href="/">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none"><path d="M3 10.5L12 4l9 6.5" stroke="currentColor" stroke-width="1.4" stroke-linecap="round" stroke-linejoin="round" /></svg>
                </a>
            </li>

            @if (UserStateService.IsLoggedIn)
            {
                <li class="nav-item">
                    <a class="nav-link d-flex align-items-center" href="profile">
                        <img src="/images/avatar-placeholder.png" class="avatar" alt="avatar" />
                        <span class="d-none d-lg-inline ms-2 user-name">@UserStateService.CurrentUser?.NombreUsuario</span>
                    </a>
                </li>

                <li class="nav-item ms-lg-2">
                    <NavLink class="btn btn-light btn-sm text-danger" href="logout" style="font-weight: 600;">
                        Cerrar sesión
                    </NavLink>
                </li>
            }
        </ul>
    </div>
</nav>

<style>
    /* ... (Todo el CSS se queda igual) ... */
</style>

@code {
    protected override void OnInitialized()
    {
        UserStateService.OnChange += HandleUserStateChange;
    }

    private async void HandleUserStateChange()
    {
        await InvokeAsync(StateHasChanged);
    }

    public void Dispose()
    {
        UserStateService.OnChange -= HandleUserStateChange;
    }
}