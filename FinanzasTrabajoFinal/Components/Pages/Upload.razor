@page "/upload"
@rendermode InteractiveServer

@using System.IO
@using System.Data
@using ExcelDataReader
@using FinanzasTrabajoFinal.MODELS
@using FinanzasTrabajoFinal.Service
@using System.Globalization
@using Microsoft.EntityFrameworkCore

@inject IDbContextFactory<FinanzasContext> DbFactory
@inject UserStateService UserStateService
@inject NavigationManager NavigationManager
@inject ILogger<Upload> Logger

<div class="card shadow-lg" style="width: 32rem; border-radius: 1rem;">
    <div class="card-header bg-success text-white text-center p-4" style="border-top-left-radius: 1rem; border-top-right-radius: 1rem;">
        <h3 class="mb-0">
            <svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" fill="currentColor" class="bi bi-file-earmark-arrow-up-fill me-2" viewBox="0 0 16 16">
                <path d="M9.293 0H4a2 2 0 0 0-2 2v12a2 2 0 0 0 2 2h8a2 2 0 0 0 2-2V4.707A1 1 0 0 0 13.707 4L10 0.293A1 1 0 0 0 9.293 0M9.5 3.5v-2l3 3h-2a1 1 0 0 1-1-1M6.354 9.854a.5.5 0 0 1-.708 0l-1.5-1.5a.5.5 0 0 1 .708-.708L6 8.293l1.146-1.147a.5.5 0 0 1 .708.708z" />
                <path d="M6 11.5a.5.5 0 0 1 .5-.5h1a.5.5 0 0 1 0 1h-1a.5.5 0 0 1-.5-.5" />
            </svg>
            Nuevo Análisis Financiero
        </h3>
    </div>
    <div class="card-body p-4">

        <p class="text-muted">
            Sube tu archivo de Excel (.xlsx) o CSV (.csv) con los Balances Generales y
            Estados de Resultados para comenzar el análisis.
        </p>

        <EditForm Model="formModel" OnValidSubmit="HandleAnalysis" FormName="UploadForm">
            <DataAnnotationsValidator />

            <div class="mb-3">
                <label for="fileUpload" class="form-label">Seleccionar archivo:</label>
                <InputFile id="fileUpload" class="form-control" OnChange="OnInputFileChange" accept=".xlsx, .csv" disabled="@isProcessing" />
            </div>

            @if (!string.IsNullOrEmpty(statusMessage))
            {
                <div class="alert alert-success" role="alert">
                    @statusMessage
                </div>
            }

            @if (!string.IsNullOrEmpty(errorMessage))
            {
                <div class="alert alert-danger" role="alert">
                    @errorMessage
                </div>
            }

            <div class="d-grid gap-2">
                <button type="submit" class="btn btn-success btn-lg" disabled="@(isProcessing || selectedFile == null)">
                    @if (isProcessing)
                    {
                        <span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span>
                        <span class="visually-hidden">Procesando...</span>
                    }
                    else
                    {
                        <span>Procesar Análisis</span>
                    }
                </button>
            </div>
        </EditForm>
        <hr class="my-4">

        <div class="d-flex justify-content-between align-items-center">
            <div>
                @if (isProcessing)
                {
                    <button class="btn btn-danger text-white" @onclick="StopProcessing">
                        Detener Proceso
                    </button>
                }
            </div>
            <div>
                <a href="/">Volver al inicio</a>
            </div>
        </div>
    </div>
</div>

@code {
    private IBrowserFile? selectedFile;
    private string statusMessage = "";
    private string errorMessage = "";
    private bool isProcessing = false;

    private UploadFormModel formModel = new UploadFormModel();
    private CultureInfo culture = new CultureInfo("es-ES");

    private CancellationTokenSource? _cts;

    private void OnInputFileChange(InputFileChangeEventArgs e)
    {
        selectedFile = e.File;
        statusMessage = $"Archivo seleccionado: {selectedFile.Name}";
        errorMessage = "";
    }

    private void StopProcessing()
    {
        _cts?.Cancel();
    }

    private async Task HandleAnalysis()
    {
        if (selectedFile == null || !UserStateService.IsLoggedIn)
        {
            errorMessage = "Por favor, selecciona un archivo y asegúrate de haber iniciado sesión.";
            return;
        }

        _cts = new CancellationTokenSource();
        isProcessing = true;
        errorMessage = "";
        statusMessage = "Iniciando procesamiento...";

        StateHasChanged();

        AnalisisFinanciero? nuevoAnalisis = null;
        int idAnalisisGenerado = 0; // Guardaremos el ID aquí

        try
        {
            await Task.Run(async () =>
            {
                await using var DbContext = await DbFactory.CreateDbContextAsync(_cts.Token);

                // --- 1. CREAR ANÁLISIS ---
                nuevoAnalisis = new AnalisisFinanciero
                {
                    IdUsuario = UserStateService.CurrentUser.IdUsuario,
                    NombreArchivo = selectedFile.Name,
                    FechaAnalisis = DateTime.Now
                };
                DbContext.AnalisisFinancieros.Add(nuevoAnalisis);
                await DbContext.SaveChangesAsync(_cts.Token);
                idAnalisisGenerado = nuevoAnalisis.IdAnalisis; // Obtenemos el ID

                var conceptosBG = new List<BGConcepto>();
                var conceptosER = new List<ERConcepto>();

                // --- 2. LEER EXCEL ---
                await using var memoryStream = new MemoryStream();
                await selectedFile.OpenReadStream(maxAllowedSize: 10485760).CopyToAsync(memoryStream, _cts.Token);
                memoryStream.Position = 0;

                using (var reader = ExcelReaderFactory.CreateReader(memoryStream))
                {
                    var dataSet = reader.AsDataSet(new ExcelDataSetConfiguration()
                    {
                        ConfigureDataTable = (_) => new ExcelDataTableConfiguration() { UseHeaderRow = false }
                    });

                    foreach (DataTable table in dataSet.Tables)
                    {
                        _cts.Token.ThrowIfCancellationRequested();

                        var tipoHoja = DetectSheetType(table);
                        if (tipoHoja == SheetType.BalanceGeneral)
                        {
                            conceptosBG.AddRange(ParseBalanceGeneral(table, nuevoAnalisis.IdAnalisis, _cts.Token));
                        }
                        else if (tipoHoja == SheetType.EstadoResultados)
                        {
                            conceptosER.AddRange(ParseEstadoResultados(table, nuevoAnalisis.IdAnalisis, _cts.Token));
                        }
                    }
                }

                if (conceptosBG.Count == 0 || conceptosER.Count == 0)
                {
                    throw new Exception("No se pudieron leer datos del BG o ER. Revisa que ambas hojas existan y tengan el formato correcto.");
                }

                // --- 3. GUARDAR DATOS CRUDOS ---
                await DbContext.BGConceptos.AddRangeAsync(conceptosBG, _cts.Token);
                await DbContext.ERConceptos.AddRangeAsync(conceptosER, _cts.Token);
                await DbContext.SaveChangesAsync(_cts.Token);

                // **** ¡NUEVO CÓDIGO DE CÁLCULO! ****
                // --- 4. REALIZAR CÁLCULOS ---

                var resultadosVerticales = new List<ResultadoVertical>();
                var resultadosHorizontales = new List<ResultadoHorizontal>();
                var razonesFinancieras = new List<RazonFinanciera>();
                var anios = conceptosBG.Select(c => c.Anio).Distinct().OrderBy(a => a).ToList();
                int anioAnterior = anios.First();
                int anioActual = anios.Last();

                // --- 4a. ANÁLISIS VERTICAL (ER) ---
                var ventasNetas = conceptosER
                    .Where(c => c.Concepto.Equals("Ingresos", StringComparison.OrdinalIgnoreCase))
                    .ToDictionary(c => c.Anio, c => c.Valor);

                foreach (var concepto in conceptosER)
                {
                    decimal baseVentas = ventasNetas.GetValueOrDefault(concepto.Anio);
                    if (baseVentas != 0)
                    {
                        resultadosVerticales.Add(new ResultadoVertical
                        {
                            IdAnalisis = nuevoAnalisis.IdAnalisis,
                            TipoEstado = "ER",
                            Anio = concepto.Anio,
                            Concepto = concepto.Concepto,
                            Porcentaje = (concepto.Valor / baseVentas) // Fórmula: (Valor / Ventas Netas) * 100
                        });
                    }
                }

                // --- 4b. ANÁLISIS VERTICAL (BG) ---
                var totalActivos = conceptosBG
                    .Where(c => c.Concepto.Equals("Total Activos", StringComparison.OrdinalIgnoreCase))
                    .ToDictionary(c => c.Anio, c => c.Valor);

                var totalPasCap = conceptosBG
                    .Where(c => c.Concepto.Equals("Total Pasivos y Capital", StringComparison.OrdinalIgnoreCase))
                    .ToDictionary(c => c.Anio, c => c.Valor);

                foreach (var concepto in conceptosBG)
                {
                    decimal baseValor = 0;
                    if (concepto.Tipo == "ACTIVO")
                    {
                        baseValor = totalActivos.GetValueOrDefault(concepto.Anio);
                    }
                    else // PASIVO o CAPITAL
                    {
                        baseValor = totalPasCap.GetValueOrDefault(concepto.Anio);
                    }

                    if (baseValor != 0)
                    {
                        resultadosVerticales.Add(new ResultadoVertical
                        {
                            IdAnalisis = nuevoAnalisis.IdAnalisis,
                            TipoEstado = "BG",
                            Anio = concepto.Anio,
                            Concepto = concepto.Concepto,
                            Porcentaje = (concepto.Valor / baseValor) // Fórmula: (Valor / Base) * 100
                        });
                    }
                }

                // --- 4c. ANÁLISIS HORIZONTAL (BG) ---
                var conceptosAgrupadosBG = conceptosBG.GroupBy(c => c.Concepto);

                foreach (var grupo in conceptosAgrupadosBG)
                {
                    var valorAnterior = grupo.FirstOrDefault(c => c.Anio == anioAnterior)?.Valor ?? 0;
                    var valorActual = grupo.FirstOrDefault(c => c.Anio == anioActual)?.Valor ?? 0;

                    if (valorAnterior != 0) // Evitar división por cero
                    {
                        decimal varAbsoluta = valorActual - valorAnterior;
                        decimal varRelativa = ((valorActual / valorAnterior) - 1); // Fórmula: ((Actual / Anterior) - 1) * 100

                        resultadosHorizontales.Add(new ResultadoHorizontal
                        {
                            IdAnalisis = nuevoAnalisis.IdAnalisis,
                            TipoEstado = "BG",
                            PeriodoInicial = anioAnterior,
                            PeriodoFinal = anioActual,
                            Concepto = grupo.Key,
                            VariacionAbsoluta = varAbsoluta,
                            VariacionRelativa = varRelativa
                        });
                    }
                }

                // --- 4d. CÁLCULO DE CNT ---
                var actCirculante = conceptosBG
                    .Where(c => c.Concepto.Equals("Total Activo Circulante", StringComparison.OrdinalIgnoreCase))
                    .ToDictionary(c => c.Anio, c => c.Valor);

                var pasCirculante = conceptosBG
                    .Where(c => c.Concepto.Equals("Total Pasivo Circulante", StringComparison.OrdinalIgnoreCase))
                    .ToDictionary(c => c.Anio, c => c.Valor);

                foreach (var anio in anios)
                {
                    decimal cnt = actCirculante.GetValueOrDefault(anio) - pasCirculante.GetValueOrDefault(anio);
                    razonesFinancieras.Add(new RazonFinanciera
                    {
                        IdAnalisis = nuevoAnalisis.IdAnalisis,
                        Anio = anio,
                        Grupo = "Liquidez",
                        NombreRazon = "Capital Neto de Trabajo (CNT)",
                        ValorRazon = cnt
                    });
                }

                // --- 5. GUARDAR CÁLCULOS ---
                await DbContext.ResultadoVerticales.AddRangeAsync(resultadosVerticales, _cts.Token);
                await DbContext.ResultadoHorizontales.AddRangeAsync(resultadosHorizontales, _cts.Token);
                await DbContext.RazonesFinancieras.AddRangeAsync(razonesFinancieras, _cts.Token);
                await DbContext.SaveChangesAsync(_cts.Token);

                // --- 6. REPORTAR ÉXITO ---
                await InvokeAsync(() =>
                {
                    statusMessage = $"¡Análisis completado! Se guardaron {conceptosBG.Count} conceptos de BG, {conceptosER.Count} conceptos de ER y se generaron todos los análisis.";
                    Logger.LogInformation(statusMessage);

                    // **** ¡REDIRECCIÓN! ****
                    // Cuando termine, te mandamos a la página de resultados
                    NavigationManager.NavigateTo($"/resultados/{idAnalisisGenerado}");
                });

            }, _cts.Token);
        }
        catch (OperationCanceledException)
        {
            statusMessage = "";
            errorMessage = "Proceso cancelado por el usuario.";

            if (nuevoAnalisis != null)
            {
                await using var DbContext = await DbFactory.CreateDbContextAsync();
                DbContext.AnalisisFinancieros.Remove(nuevoAnalisis);
                await DbContext.SaveChangesAsync();
            }
        }
        catch (Exception ex)
        {
            statusMessage = "";
            errorMessage = $"Error: {ex.Message} | DETALLE INTERNO: {ex.InnerException?.Message}";
            Logger.LogError(ex, "Error en HandleAnalysis");

            if (nuevoAnalisis != null)
            {
                await using var DbContext = await DbFactory.CreateDbContextAsync();
                DbContext.AnalisisFinancieros.Remove(nuevoAnalisis);
                await DbContext.SaveChangesAsync();
            }
        }
        finally
        {
            isProcessing = false;
            _cts?.Dispose();
            StateHasChanged();
        }
    }

    // --- MÉTODOS DE PARSEO ---

    private enum SheetType { Unknown, BalanceGeneral, EstadoResultados }

    private SheetType DetectSheetType(DataTable table)
    {
        // ... (Se queda igual) ...
    }

    private int SafeGetYear(DataRow row, int colIndex)
    {
        // ... (Se queda igual) ...
    }


    private List<ERConcepto> ParseEstadoResultados(DataTable table, int analisisId, CancellationToken token)
    {
        // ... (Se queda igual) ...
    }

    private List<BGConcepto> ParseBalanceGeneral(DataTable table, int analisisId, CancellationToken token)
    {
        // ... (Se queda igual) ...
    }

    // --- MÉTODOS AYUDANTES ---

    private string SafeGetString(DataRow row, int colIndex)
    {
        // ... (Se queda igual) ...
    }

    private decimal SafeGetDecimal(DataRow row, int colIndex, CultureInfo culture)
    {
        // ... (Se queda igual) ...
    }

    public class UploadFormModel
    {
        // (se queda igual)
    }
}